# Bisect 任务管理

## 概述

`bisect_task` 是一个用于自动化处理 bisect 任务的服务。它通过与 Manticore 数据库交互，管理任务的提交、处理和状态更新。

## 功能

- **任务提交**：通过 API 接口提交新的 bisect 任务。
- **任务处理**：自动从数据库中获取待处理任务，并执行 bisect 操作。
- **状态更新**：实时更新任务状态，并将结果存储到数据库中。
- **回归检查**：更新回归数据库以记录任务的执行结果。

## 数据库设计

### Bisect 表结构

`bisect` 表用于存储所有的 bisect 任务信息。其结构如下：

- **`id`**: `bigint`，任务的唯一标识符。
- **`bad_job_id`**: `string`，标记为不良的作业ID。
- **`error_id`**: `string`，任务相关的错误标识符。
- **`bisect_status`**: `string`，任务的当前状态（如 `wait`、`processing`、`completed`、`failed`）。
- **其他字段**：用于存储任务的详细信息。

### 回归检查表结构

`regression` 表用于存储回归检查的结果。其结构如下：

- **`id`**: `bigint`，唯一标识符。
- **`record_type`**: `string`，记录类型，通常为 `errid`。
- **`errid`**: `string`，错误标识符。
- **`category`**: `string`，错误类别。
- **其他字段**：用于存储回归检查的详细信息。

## 任务处理流程

### 生产者流程

- **任务发现**：定期从 `jobs` 数据库中获取新的故障任务。
- **任务过滤**：根据错误标识符的白名单过滤任务。
- **任务提交**：将符合条件的任务提交到 `bisect` 数据库。

### 消费者流程

- **任务获取**：从 `bisect` 数据库中获取状态为 `wait` 的任务。
- **任务执行**：执行 bisect 操作以查找故障提交。
- **结果更新**：更新任务状态为 `completed` 或 `failed`，并记录结果。
- **回归检查**：更新 `regression` 数据库以记录任务的执行结果。

## 历史设计讨论

### Bisect 提交

#### 方式1:
- 在特定测试机上运行
- 确保安全性：账户/令牌，访问服务

#### 方式2:
- 提交 job1
- 提交 job2，重用相同的账户信息
- 问题：消耗信用/机器时间

#### 方式3:
- compass ci 容器运行为服务
- 参考 delimiter 服务
- 提供 API/new-bisect-task，添加到 ES
- 循环：从 ES 消费一个任务，fork 进程，开始 bisect

### 回归数据库
### Bisect 任务队列
### Bisect 任务管理和仪表板

- Bisect 任务名称
- 套件，开始时间/运行时间，步骤，组ID

